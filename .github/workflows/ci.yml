name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ç±»åž‹æ£€æŸ¥
      run: npm run type-check
      
    - name: ä»£ç é£Žæ ¼æ£€æŸ¥
      run: |
        npm run lint:check || echo "Lint check skipped - no lint script configured"
        
    - name: æž„å»ºæµ‹è¯•
      run: |
        npm run build:h5
        echo "H5 æž„å»ºæˆåŠŸ"
        
    - name: å°ç¨‹åºæž„å»ºæµ‹è¯•
      run: |
        npm run build:mp-weixin
        echo "å¾®ä¿¡å°ç¨‹åºæž„å»ºæˆåŠŸ"

  security:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: å®‰å…¨æ¼æ´žæ‰«æ
      run: npm audit --audit-level high
      
    - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD

  deploy-staging:
    name: éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æž„å»ºé¡¹ç›®
      run: |
        npm run build:h5
        npm run build:mp-weixin
        
    - name: éƒ¨ç½²åˆ° CloudBase æµ‹è¯•çŽ¯å¢ƒ
      env:
        TCB_SECRET_ID: ${{ secrets.TCB_SECRET_ID }}
        TCB_SECRET_KEY: ${{ secrets.TCB_SECRET_KEY }}
        TCB_ENV_ID: ${{ secrets.TCB_ENV_ID_STAGING }}
      run: |
        npm install -g @cloudbase/cli
        tcb login
        tcb functions:deploy
        echo "æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"

  deploy-production:
    name: éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æž„å»ºé¡¹ç›®
      run: |
        npm run build:h5
        npm run build:mp-weixin
        npm run build:mp-toutiao
        npm run build:mp-alipay
        
    - name: éƒ¨ç½²åˆ° CloudBase ç”Ÿäº§çŽ¯å¢ƒ
      env:
        TCB_SECRET_ID: ${{ secrets.TCB_SECRET_ID }}
        TCB_SECRET_KEY: ${{ secrets.TCB_SECRET_KEY }}
        TCB_ENV_ID: ${{ secrets.TCB_ENV_ID_PRODUCTION }}
      run: |
        npm install -g @cloudbase/cli
        tcb login
        tcb functions:deploy
        echo "ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"
        
    - name: åˆ›å»ºå‘å¸ƒæ ‡ç­¾
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        echo "å‘å¸ƒæ ‡ç­¾: ${{ github.ref_name }}"
        
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          dist/
          unpackage/
        retention-days: 30

  release:
    name: åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    needs: deploy-production
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
      run: |
        echo "## ðŸŽ‰ å¿ƒè¿¹æ³¡æ³¡ ${{ github.ref_name }} å‘å¸ƒ" > release-notes.md
        echo "" >> release-notes.md
        echo "### æ–°åŠŸèƒ½" >> release-notes.md
        echo "- æ·»åŠ æ–°åŠŸèƒ½æè¿°" >> release-notes.md
        echo "" >> release-notes.md
        echo "### ä¿®å¤" >> release-notes.md
        echo "- ä¿®å¤ bug æè¿°" >> release-notes.md
        echo "" >> release-notes.md
        echo "### æ”¹è¿›" >> release-notes.md
        echo "- æ€§èƒ½ä¼˜åŒ–å’Œä½“éªŒæ”¹è¿›" >> release-notes.md
        
    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        body_path: release-notes.md
        files: |
          dist/**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}