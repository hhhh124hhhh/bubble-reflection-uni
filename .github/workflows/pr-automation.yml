name: PR è‡ªåŠ¨åŒ–

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ç±»å‹æ£€æŸ¥
      run: npm run type-check
      
    - name: æ„å»ºæµ‹è¯•
      run: |
        npm run build:h5
        npm run build:mp-weixin
        
    - name: PR ä¿¡æ¯æ£€æŸ¥
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const body = pr.body || '';
          
          // æ£€æŸ¥ PR æè¿°æ˜¯å¦åŒ…å«å¿…è¦ä¿¡æ¯
          if (body.length < 50) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: 'âš ï¸ è¯·æä¾›æ›´è¯¦ç»†çš„ PR æè¿°ï¼ŒåŒ…æ‹¬ï¼š\n- ğŸ“ å˜æ›´å†…å®¹è¯´æ˜\n- ğŸ› ä¿®å¤çš„é—®é¢˜æˆ–æ–°å¢çš„åŠŸèƒ½\n- ğŸ§ª æµ‹è¯•æƒ…å†µ\n- ğŸ“¸ ç›¸å…³æˆªå›¾ï¼ˆå¦‚é€‚ç”¨ï¼‰'
            });
          }
          
    - name: æ›´æ–° PR æ ‡ç­¾
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request;
          const labels = [];
          
          // æ ¹æ®æ–‡ä»¶å˜æ›´è‡ªåŠ¨æ·»åŠ æ ‡ç­¾
          if (pr.changed_files && pr.changed_files.some(file => file.filename.includes('src/'))) {
            labels.push('ä»£ç å˜æ›´');
          }
          
          if (pr.changed_files && pr.changed_files.some(file => file.filename.includes('docs/'))) {
            labels.push('æ–‡æ¡£æ›´æ–°');
          }
          
          if (pr.changed_files && pr.changed_files.some(file => file.filename.includes('cloudfunctions/'))) {
            labels.push('äº‘å‡½æ•°');
          }
          
          if (labels.length > 0) {
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: labels
            });
          }